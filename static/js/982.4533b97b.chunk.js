"use strict";(self.webpackChunkreact_widget_template=self.webpackChunkreact_widget_template||[]).push([[982],{4796:(e,t,a)=>{a.r(t),a.d(t,{default:()=>q,start:()=>V});var n=a(5043),o=a(4391),s=(a(2342),a(9555),a(3003)),r=a(2670),l=a(2115),i=(a(8421),a(4050),a(9959),a(174)),c=a(2725),d=a(3277),u=a(6713),g=a(5645),m=a(6244),p=a(9332),h=a(5072),f=a(9269),v=a(4392),w=a(2010),y=a(2268),A=a(6047);const P="https://oi000186152-us1-space.3dexperience.3ds.com/enovia",C=()=>{const{showErrorToast:e}=(0,c.A)(),t=(0,s.wA)();let a=window.widget.getValue("email");console.log("Email in usePlantAssignment:",a);return{handlePlantAssignment:async(n,o,s,r)=>{try{t((0,g.Ve)(!0));const l=await(0,y.I)();if(!l)return void e(d.rK);console.log("[UsePlantAssignment] Headers:",l);let i=[];if("Change Action"===r){const e=async()=>{const e=await(0,p.g)([n],l,s);return console.log("Parallel API response:",e),t((0,g.QL)(e)),e};let a=!1;console.log("The object Type is Change Action");const o=async e=>{const t="".concat(P,"/resources/v1/modeler/dslc/changeaction/").concat(s,"?%24fields=proposedChanges,realizedChanges"),n=await(0,A.ui)("GET",t,"",l);if(console.log("Response from Change Action URL:",n),n.status&&n.output){const t=n.output.realizedChanges.map((e=>e.where.identifier)),o=n.output.proposedChanges.map((async n=>{let o=n.where.identifier,s=n.where.type;if("Raw_Material"==s||"VPMReference"==s||"CreateAssembly"==s||"Provide"==s||"CreateMaterial"==s){if("NewVersion"===n.target){const e=await async function(e,t,a){const n="".concat(P,"/resources/v1/modeler/dslc/version/getGraph"),o="";try{const r="Raw_Material"===t?"/resources/v1/modeler/dsrm/dsrm:RawMaterial/".concat(e):"/resources/v1/modeler/dseng/dseng:EngItem/".concat(e),l={data:[{id:e,identifier:e,type:t,source:P,relativePath:r}]},i=await(0,A.ui)("POST",n,l,a);if(!i.status||!i.output)return console.error("API response does not contain the expected 'status' and 'output'."),o;{var s;const t=(null===(s=i.output.results[0])||void 0===s?void 0:s.versions)||[];for(const a of t)if(a.ancestors&&a.ancestors.some((t=>t.identifier===e)))return a.id}}catch(r){return console.error("Error fetching getLatestRevision for ".concat(e,":"),r),o}}(o,s,l);t.includes(e)&&(o=e)}if("Raw_Material"!==s&&"VPMReference"!==s){a=!0;const e=await async function(e,t){let a="";a="".concat(P,"/resources/v1/modeler/dsmfg/dsmfg:MfgItem/").concat(e,"/dsmfg:ScopeEngItem");try{const n=await(0,A.ui)("GET",a,"",t);return n.status&&n.output?{identifier:n.output.member[0].ScopeEngItem.identifier,type:n.output.member[0].ScopeEngItem.type}:(console.log("No valid response for identifier ".concat(e)),{})}catch(n){return console.error("Error fetching item details for ".concat(e,":"),n),{}}}(o,l);console.log("MFG Details are:",e),o=e.identifier,s=e.type}if(void 0!==o&&void 0!==s)try{var c,d,u,g;const t=await async function(e,t,a){let n="";n="Raw_Material"===t?"".concat(P,"/resources/v1/modeler/dsrm/dsrm:RawMaterial/").concat(e):"".concat(P,"/resources/v1/modeler/dseng/dseng:EngItem/").concat(e,"?mask=dsmveng:EngItemMask.Details");try{const t=await(0,A.ui)("GET",n,"",a);return t.status&&t.output?t.output:(console.log("No valid response for identifier ".concat(e)),{})}catch(o){return console.error("Error fetching item details for ".concat(e,":"),o),{}}}(o,s,l),a=null===t||void 0===t||null===(c=t.member)||void 0===c||null===(d=c[0])||void 0===d?void 0:d.state,n=await async function(e,t,a,n,o){const s=[];let r=!1;const l="".concat(P,"/resources/v1/modeler/dslib/dslib:CategorizationClassifiedItem/").concat(e,"?$mask=dslib:ClassificationAttributesMask");try{var i,c;const d=await(0,A.ui)("GET",l,"",t);console.log("Response for identifier ".concat(e,":"),d);let u=(null===(i=d.output.member[0])||void 0===i||null===(c=i.ClassificationAttributes)||void 0===c?void 0:c.member)||[];u=u.filter((e=>{const t=e.Attributes.find((e=>"PlantAssignmentClass"===e.name)),a=e.Attributes.find((e=>"AllPlantsRemoved"===e.name));return!0===(null===t||void 0===t?void 0:t.value)||!0===(null===a||void 0===a?void 0:a.value)})),0===u.length&&(u=await(0,w.a)(t,a,e,n,o)),r=u.some((e=>{const t=e.Attributes.find((e=>"AllPlantsRemoved"===e.name));return!0===(null===t||void 0===t?void 0:t.value)})),u.length>0?u.forEach((e=>{const t=e.ClassID;let n=null,o=null,r=!1,l="";var i;(e.Attributes.forEach((e=>{e.name.includes("PlantAssignmentClass")&&(r=e.value),e.name.includes("PlantStatus")&&(o=e.value),e.name.includes("FlowDownCA")&&(l=e.value)})),r)&&(n=null===(i=a.find((e=>e.id===t)))||void 0===i?void 0:i.title,n&&s.push({PlantName:n,PlantID:t,PlantERPStatus:o||"Pending",PlantFlowDownCA:l}))})):console.log("No valid classification data for identifier ".concat(e))}catch(d){console.error("Error fetching assigned classes for ".concat(e,":"),d)}return{ItemPlants:s,hasNoPlants:r}}(o,l,e,a,r),m=n.ItemPlants,p=n.hasNoPlants;console.log("Item Plants are:",m),console.log("Has No Plants are:",p),console.log("ItemObjectdetails:",n),i.push({ItemId:o,ItemType:s,ItemState:(null===t||void 0===t?void 0:t.member[0].state)||"N/A",ItemTitle:(null===t||void 0===t?void 0:t.member[0].title)||"N/A",ItemMBOM:(null===t||void 0===t||null===(u=t.member[0])||void 0===u||null===(g=u["dseno:EnterpriseAttributes"])||void 0===g?void 0:g.EMR_hasMBOM)||"N/A",ItemPlants:m,hasNoPlants:p})}catch(m){console.error("Error processing change for item ".concat(o,":"),m)}}}));await Promise.all(o)}else console.error("Invalid response structure or no proposed changes.")},c=await e();await o(c),t((0,g.Ve)(!1)),t((0,g.OL)(i)),t((0,g.Dr)(a)),t((0,g.lT)(l))}else{const e=await(0,m.o)(l,s,a);console.log("[Plant Assignment] User Groups:",e);let i=[...e,n];console.log("[Use Plant Assignment] All CollabSpaces:",i);let c=[];if(i.length>0?(c=await(0,p.g)(i,l,s),console.log("[Use Plant Assignment] All Plants:",c)):console.warn("[Use Plant Assignment] No CollabSpaces found."),c.length>0){const e=await(0,v.d)(c,l,s,o,r);console.log("[Use Plant Assignment]: ",e),e.success?(t((0,g.Lq)(e.data.plantData)),t((0,g.lL)(l))):console.error("Failed to fetch plant data.")}else console.warn("[Use Plant Assignment] No Plants found.");let d={};d="Raw_Material"===r?{success:!0,data:[]}:await(0,h.P)(l,s,r),console.log("Type After:",r),console.log("[Use Plant Assignment] Product Children:",d),d.success&&t((0,g.VG)(d.data));const u=await(0,f.B)(l,s,o);console.log("[Use Plant Assignment] CA Details:",u),u.success&&(t((0,g.ug)(u.data)),t((0,g.aB)(u.proposedChanges)),t((0,g.hF)(u.CAData))),console.log("[Plant Assignment] All services executed successfully.")}}catch(l){console.error("[Plant Assignment] Error:",l),e("An error occurred while fetching plant assignment data.")}finally{t((0,g.Ve)(!1))}}}};var b=a(314);const D=()=>{const{showErrorToast:e}=(0,c.A)(),{handlePlantAssignment:t}=C(),a=(0,s.d4)((e=>e.droppedObject.isDropped)),o=(0,s.d4)((e=>e.droppedObject.loading)),r=(0,s.wA)(),l=(0,n.useCallback)((async a=>{try{const s=await(0,b.Sj)({dataItems:a});if(s.success){r((0,g.um)({cardData:s.data.cardData}));const e=s.data.cardData;var n,o;if(console.log("[Dragged Items are]",e),r((0,g.Rr)(!0)),s)await t(e["Collaborative Space"],e["Maturity State"],null===(n=a[0])||void 0===n?void 0:n.objectId,null===(o=a[0])||void 0===o?void 0:o.objectType)}else e(d.wX)}catch(s){console.error("[FetchObjectDetails] Error fetching details:",s),e(d.wX)}finally{r((0,g.r1)(!1))}}),[r,t]),i=(0,n.useCallback)((async t=>{console.log("[handleDrop] handleDrop called with dataItems:",t);try{if(t&&t.length>0){var a;const n=null===(a=t[0])||void 0===a?void 0:a.objectType;if(!["VPMReference","Raw_Material","Change Action"].includes(n))return void e(d.Zo);r((0,g.Rr)(!0)),console.log("[handleDrop] \ud83d\udd04 Force setting `loading = true`..."),r((0,g.r1)(!1)),setTimeout((()=>r((0,g.r1)(!0))),0),await l(t)}else console.warn("[handleDrop] No data items to process.")}catch(n){console.error("[Drop] Error in handleDrop:",n),r((0,g.r1)(!1)),console.log("[handleDrop] Error in handleDrop, setting loading to false"),e(d.nz)}}),[l,e]);return{initializeDroppableArea:(0,n.useCallback)((()=>{a?console.log("[initializeDroppableArea] \u23f3 isDropped is already true. Skipping reset."):(console.log("[initializeDroppableArea] \ud83d\ude80 Resetting isDropped to false..."),r((0,g.Rr)(!1)));const t=setInterval((()=>{const a=document.querySelector(".droppable-container");a&&(clearInterval(t),(0,b.pn)(a,i,r,e))}),100);return()=>clearInterval(t)}),[i,r]),loading:o,handleDrop:i}};var S=a(579);const E=()=>{const{handleDrop:e}=D(),{showSuccessToast:t,showErrorToast:a}=(0,c.A)(),[o,s]=(0,n.useState)(!1);console.log("---[WidgetLifecycle]--- starts");return(0,n.useEffect)((()=>{if(!window.widget)return;console.trace("[WidgetLifecycle] \ud83d\udd04 `onRefresh` was called from:"),window.widget.addEvent("onRefresh",(async()=>{var n,o;const l=(new Error).stack.split("\n"),c=sessionStorage.getItem("userClickedRefresh");if((e=>e.some((e=>e.includes("UWA_Frame_Alone.js")||e.includes("bundle-min.js"))))(l)&&!c)return void console.warn("[WidgetLifecycle] \u26d4 Auto-refresh detected. Ignoring unwanted `onRefresh`.");sessionStorage.removeItem("userClickedRefresh"),s(!0);const u=r.A.getState().droppedObject.droppedObjectData.initialDraggedData;if(null===u||void 0===u||null===(n=u.data)||void 0===n||null===(o=n.items)||void 0===o||!o.length)return console.error("[WidgetLifecycle] \u26a0\ufe0f `initialDraggedData` is missing or invalid:",u),void s(!1);try{await(0,i.M)(u.data.items,e)}catch(g){console.error("[WidgetLifecycle] \u274c Error during refresh:",g),a(d.H6)}finally{s(!1),t(d._l)}}))}),[]),o?(0,S.jsx)(u.A,{}):null};var I=a(9379),R=a(4816),j=a(4282),M=a(768),x=a(759),k=a(6878),N=a(3825);const F=e=>{let{plants:t=[],itemId:a,isRemoveMode:n,handleRemovePlant:o,isMFGCA:s}=e;return console.log("CompanionRenderer received plants:",t),null!==t&&void 0!==t&&t.length?(0,S.jsx)(S.Fragment,{children:t.map((e=>(0,S.jsxs)("span",{style:{marginRight:"8px",display:"inline-flex",alignItems:"center",color:e.color||"black",fontWeight:"bold"},children:[e.PlantName,"green"===e.color&&" - Add","red"===e.color&&(s?" - Updated":" - Removed"),n&&"Pending"===e.PlantERPStatus&&(0,S.jsx)(N.zhF,{size:16,style:{cursor:"pointer",color:"red",marginLeft:"4px"},onClick:()=>o(a,e.PlantID)})]},e.PlantID)))}):"N/A"},L=(e,t,a,n,o)=>(console.log("type here is: ",t),"Change Action"===t?[{accessorKey:"ItemName",header:"Item Name"},{accessorKey:"Plant",header:"Plant",cell:e=>{let{row:t}=e;const s=t.original.Plant,r=Array.isArray(s)?s.map((e=>e.PlantName||e.title||"")).join(", "):"N/A";return(0,S.jsx)("span",{title:r,children:(0,S.jsx)(F,{plants:s,itemId:t.original.ItemId,isRemoveMode:a,handleRemovePlant:n,isMFGCA:o})})}}]:[{accessorKey:"Plant",header:"Plant"},{accessorKey:"Seq",header:"Seq"},{accessorKey:"Status",header:"Status"},{accessorKey:"Change",header:"Change"},{accessorKey:"Change Status",header:"Change Status"},{accessorKey:"MFG Change",header:"MFG Change"},{accessorKey:"MFG Status",header:"MFG Status"},{accessorKey:"Oracle Template",header:"Oracle"},{accessorKey:"MBom",header:"MBom"},{accessorKey:"ERP Status",header:"ERP Status"},{accessorKey:"ERP Export",header:"ERP Export"},{accessorKey:"Lead Plant",header:"Lead Plant"},{accessorKey:"Sort Value",header:"Sort Value"}]);var T=a(3127);a(5362),a(6313),a(3728);var O=a(1238),K=a(3353),_=(a(6292),a(9722));a(5658),a(3910);const G=()=>{const[e,t]=(0,n.useState)(!1),[a,o]=(0,n.useState)(!1),[r,l]=(0,n.useState)(null),[c,d]=(0,n.useState)([]),[u,m]=(0,n.useState)(""),[p,h]=(0,n.useState)(""),[f,v]=(0,n.useState)([]),[w,y]=(0,n.useState)([]),[A,P]=(0,n.useState)([]),[C,b]=(0,n.useState)([]),[D,E]=(0,n.useState)([]),[N,F]=(0,n.useState)([]),[G,U]=(0,n.useState)(!1),[V,q]=(0,n.useState)(Date.now()),[B,W]=(0,n.useState)(!1),[z,H]=(0,n.useState)([]),X=(0,s.wA)(),{caItemDetails:Q,caItemObjectDetails:Z,droppedObjectData:$,plantObjectData:J}=(0,s.d4)((e=>e.droppedObject)),Y=((0,n.useMemo)((()=>D.map((e=>(0,I.A)((0,I.A)({},e),{},{key:e.id})))),[D]),(0,n.useMemo)((()=>A.map((e=>(0,I.A)((0,I.A)({},e),{},{key:e.id})))),[A]));return(0,n.useEffect)((()=>{(0,i.M)().then((e=>{const{plantData:t,cardData:a,tableData:n}=e;v(t),E(a),P(n),X((0,g.Lq)(t)),X((0,g.OL)(a)),X((0,g.um)(n))})).catch((e=>{console.error("Error fetching data:",e)}))}),[X]),(0,S.jsxs)("div",{className:"companion-widget",children:[(0,S.jsxs)("div",{className:"widget-header",children:[(0,S.jsx)("h2",{children:"Companion Widget"}),(0,S.jsx)(j.A,{variant:"primary",onClick:()=>t(!0),children:"Open Confirmation Modal"})]}),(0,S.jsxs)("div",{className:"widget-content",children:[(0,S.jsx)(R.A,{title:"Card Title",content:"Card content goes here.",footer:"Card footer"}),(0,S.jsx)(M.A,{columns:L,data:Y,onRowSelect:(e,t)=>{y(t),X((0,g.dT)(t))},meta:{updateTableData:e=>{P(e)}},widgetType:"Companion_Widget"}),(0,S.jsx)(x.A,{data:$,onDrop:e=>{F((t=>[...t,e])),U(!0)},onDragEnd:()=>U(!1)}),(0,S.jsxs)("div",{className:"file-upload",children:[(0,S.jsx)("input",{type:"file",accept:".xlsx, .xls",onChange:e=>{const t=e.target.files[0];if(t){l(t);const e=new FileReader;e.onload=e=>{const t=e.target.result,a=O.LF(t,{type:"binary"}),n=a.SheetNames[0],o=a.Sheets[n],s=O.Wp.sheet_to_json(o,{header:1});console.log(s)},e.readAsBinaryString(t)}}},V),(0,S.jsx)(j.A,{variant:"success",onClick:()=>{if(!r)return;o(!0);const e=new FormData;e.append("file",r),_.A.post("/api/process-file",e,{headers:{"Content-Type":"multipart/form-data"}}).then((e=>{o(!1),m("File processed successfully!"),d([]),H([]),W(!0);const{plantData:t,cardData:a,tableData:n}=e.data;v(t),E(a),P(n),X((0,g.Lq)(t)),X((0,g.OL)(a)),X((0,g.um)(n))})).catch((e=>{o(!1),h("Error processing file."),m(""),d([]),H([]),W(!0),console.error("Error processing file:",e)}))},disabled:a||!r,children:a?"Processing...":"Process File"})]}),(0,S.jsxs)("div",{className:"actions",children:[(0,S.jsx)(j.A,{variant:"danger",onClick:()=>{q(Date.now()),l(null),d([]),m(""),h(""),v([]),E([]),P([]),X((0,g.Lq)([])),X((0,g.OL)([])),X((0,g.um)([]))},disabled:a,children:a?"Resetting...":"Reset"}),(0,S.jsx)(j.A,{variant:"warning",onClick:()=>{o(!0),(0,T.iu)({tableData:A,cardData:D}).then((e=>{o(!1),m("Data saved successfully!"),h(""),d([]),H([]),W(!0)})).catch((e=>{o(!1),h("Error saving data."),m(""),d([]),H([]),W(!0),console.error("Error saving data:",e)}))},disabled:a,children:a?"Saving...":"Save Data"})]})]}),(0,S.jsx)(k.A,{show:e,onHide:()=>t(!1),onConfirm:()=>{t(!1)},title:"Confirm Action",body:"Are you sure you want to perform this action?"}),(0,S.jsx)(K.A,{show:B,onHide:()=>W(!1),errors:z,title:"Content Errors",successMessage:u,failureMessage:p})]})};let U=null;function V(){var e,t;requirejs(["DS/PlatformAPI/PlatformAPI"],(e=>{window.PlatformAPI=e}));let a=(null===(e=window.widget)||void 0===e||null===(t=e.body)||void 0===t?void 0:t.querySelector("#root"))||document.getElementById("root");a||(a=document.createElement("div"),a.id="root",window.widget&&window.widget.body?window.widget.body.appendChild(a):document.body.appendChild(a)),U||(U=o.createRoot(a)),U.render((0,S.jsxs)(s.Kq,{store:r.A,children:[(0,S.jsx)(E,{}),(0,S.jsx)(G,{}),(0,S.jsx)(l.N9,{})]}))}function q(){window.widget&&V()}!function(){if(window.parent&&window.parent.document){let e=window.parent.document.createElement("script");e.textContent='\n    function listenForRefreshClicks() {\n      // console.log("\ud83c\udf0d [Parent] Listening for manual refresh clicks...");\n\n      document.body.addEventListener("click", function (event) {\n        let refreshButton = event.target.closest("#refresh"); // Check if refresh was clicked\n\n        if (refreshButton) {\n          // console.log("\u2705 [Parent] User clicked Refresh!");\n          sessionStorage.setItem("userClickedRefresh", "true"); // Store flag\n          // console.log("Stored Flag:", sessionStorage.getItem("userClickedRefresh"));\n        }\n      }, true);\n    }\n\n    // \u2705 Ensure event listener is added even if DOM is already loaded\n    if (document.readyState === "loading") {\n      document.addEventListener("DOMContentLoaded", listenForRefreshClicks);\n    } else {\n      listenForRefreshClicks();\n    }\n  ',window.parent.document.body.appendChild(e)}else console.warn("\u26a0\ufe0f [index.js] Unable to inject script\u2014parent window not accessible.")}()}}]);
//# sourceMappingURL=982.4533b97b.chunk.js.map